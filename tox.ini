[tox]
requires =
    tox>=4
env_list =
    py{37,38,39,310}-test
    test-onnx-preview
    examples
    build
labels =
    python310 = py310-test, build, examples
    python39 = py39-test, build, examples
    python38 = py38-test, build, examples
    python37 = py37-test, build, examples
    python310-experimental = test-onnx-preview
    python310-nightly = test-torch-nightly

[testenv]
description = run unit tests
deps =
    numpy==1.23.5

    ; ATen lib
    beartype
    types-PyYAML

    ; Testing
    expecttest
    parameterized
    pytest-cov
    pytest-subtests
    pytest-xdist
    pytest!=7.1.0
    pyyaml
commands =
    pip list | grep numpy
    pip list | grep onnx
    pip list | grep torch
    pytest -v onnxscript --cov=onnxscript --cov-report=xml -n=auto

[testenv:test]
    {[testenv]deps}
    onnx==1.13
    onnxruntime
    torch==1.13
commands =
    {[testenv]commands}

[testenv:test-onnx-preview]
description = test with onnx experimental builds
deps=
    {[testenv]deps}
    --pre -f https://onnxruntimepackages.z14.web.core.windows.net/onnx-function-experiment.html
    onnx-function-experiment
    --pre -f https://onnxruntimepackages.z14.web.core.windows.net/onnxruntime-function-experiment.html
    ort-function-experiment-nightly
    torch==1.13
commands =
    {[testenv]commands}

[testenv:test-torch-nightly]
description = test with pytorch nightly
deps=
    {[testenv]deps}
    onnx==1.13
    onnxruntime
    --pre -f https://download.pytorch.org/whl/nightly/cpu
    torch
commands =
    {[testenv]commands}

[testenv:examples]
description = test examples
deps =
    {[testenv]deps}
commands =
    pytest -v docs/test -n=auto

[testenv:build]
description = build package
skip_install = true
commands =
    python -m build

[gh]
python =
    3.7: py37-test, build
    3.8: py38-test, build
    3.9: py39-test, build
    3.10: py310-test, build, examples, test-onnx-preview, test-torch-nightly
