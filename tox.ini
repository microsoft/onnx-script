[tox]
requires =
    tox>=4
env_list =
    test
    test_onnx_preview
    examples
    build
    py{37,38,39,310}

[testenv]
description = run unit tests
deps =
    numpy==1.23.5

    ; ATen lib
    beartype
    types-PyYAML

    ; Testing
    expecttest
    parameterized
    pytest-cov
    pytest-subtests
    pytest-xdist
    pytest!=7.1.0
    pyyaml
    onnx==1.13
    onnxruntime
    torch==1.13
commands =
    pip list | grep numpy
    pip list | grep onnx
    pip list | grep torch
    pytest -v onnxscript --cov=onnxscript --cov-report=xml -n=auto

[testenv:test_onnx_preview]
description = test with onnx experimental builds
deps=
    {[testenv]deps}
    --pre -f https://onnxruntimepackages.z14.web.core.windows.net/onnx-function-experiment.html
    onnx-function-experiment
    --pre -f https://onnxruntimepackages.z14.web.core.windows.net/onnxruntime-function-experiment.html
    ort-function-experiment-nightly
    torch==1.13
commands =
    pip list | grep numpy
    pip list | grep onnx
    pip list | grep torch
    pytest -v onnxscript --cov=onnxscript --cov-report=xml -n=auto

[testenv:test_torch_nightly]
description = test with pytorch nightly
deps=
    {[testenv]deps}
    onnx==1.13
    onnxruntime
    --pre -f https://download.pytorch.org/whl/nightly/cpu
    torch

[testenv:examples]
description = test examples
deps =
    {[testenv]deps}
commands =
    pytest -v docs/test -n=auto

[testenv:build]
description = build package
skip_install = true
commands =
    python -m build

[gh]
python =
    3.7: py37, build
    3.8: py38, build
    3.9: py39, build
    3.10: py310, build, examples, test_onnx_preview, test_torch_nightly
